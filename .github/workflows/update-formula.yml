name: Update Formula on Rona Release

on:
  repository_dispatch:
    types: [rona-release]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Ensure checksum script is executable
        run: |
          chmod +x ./get-checksum.sh

      - name: Compute sha256 from tarball
        id: sha
        run: |
          TAR_URL='${{ github.event.client_payload.tarball_url }}'
          echo "Tarball: ${TAR_URL}"
          SHA=$(bash ./get-checksum.sh "${TAR_URL}")
          echo "sha256=${SHA}" >> "$GITHUB_OUTPUT"

      - name: Update Formula/rona.rb
        run: |
          TAG='${{ github.event.client_payload.tag }}'
          VERSION="${TAG#v}"
          SHA='${{ steps.sha.outputs.sha256 }}'
          SHA_ARM64='${{ github.event.client_payload.sha256_arm64_sequoia }}'
          SHA_SEQUOIA='${{ github.event.client_payload.sha256_sequoia }}'
          SHA_LINUX='${{ github.event.client_payload.sha256_x86_64_linux }}'
          FORMULA='Formula/rona.rb'

          # Update the url line
          sed -i.bak "s|^  url \".*\"|  url \"https://github.com/rona-rs/rona/archive/refs/tags/${TAG}.tar.gz\"|" "$FORMULA"
          # Update the source sha256 line (top-level, not inside bottle block)
          sed -i.bak "s|^  sha256 \".*\"|  sha256 \"${SHA}\"|" "$FORMULA"
          # Update the version line
          sed -i.bak "s|^  version \".*\"|  version \"${VERSION}\"|" "$FORMULA"
          # Update the test assertion line (assumes format: assert_match "rona X", ...)
          sed -i.bak "s|assert_match \"rona [^\"]*\"|assert_match \"rona ${VERSION}\"|" "$FORMULA"
          # Update bottle SHA256s
          sed -i.bak "/arm64_sequoia:/s/\"[^\"]*\"/\"${SHA_ARM64}\"/" "$FORMULA"
          sed -i.bak "/, sequoia:/s/\"[^\"]*\"/\"${SHA_SEQUOIA}\"/" "$FORMULA"
          sed -i.bak "/x86_64_linux:/s/\"[^\"]*\"/\"${SHA_LINUX}\"/" "$FORMULA"
          rm -f "${FORMULA}.bak"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "rona: bump to ${{ github.event.client_payload.tag }}"
          branch: bump/rona-${{ github.event.client_payload.tag }}
          title: "rona: bump to ${{ github.event.client_payload.tag }}"
          body: |
            Bump `Formula/rona.rb` to `${{ github.event.client_payload.tag }}`.
            - Update `url` to the new tag tarball
            - Update `sha256` to the tarball checksum
            - Update `version` and test assertion
